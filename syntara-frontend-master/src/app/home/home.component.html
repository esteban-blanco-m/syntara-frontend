<main class="main-content" [class.active-view]="hasSearched">

  <div class="enterprise-section" *ngIf="isEnterpriseUser && !hasSearched">
    <div class="main-logo-section">
      <img src="assets/images/logo.png" alt="Syntara Main Logo" class="main-logo">
    </div>
    <h2 class="search-prompt">
      ¬øQu√© reporte quieres generar hoy <span *ngIf="greetingName">{{ greetingName }}</span>?
    </h2>
    <div class="reports-grid">
      <button class="report-btn" routerLink="/wholesale-search">
        <div class="btn-icon">üìä</div>
        <span>Precio por Volumen</span>
      </button>

      <button class="report-btn" routerLink="/competitor-report">
        <div class="btn-icon">‚öîÔ∏è</div>
        <span>Reporte Competencia</span>
      </button>

    <button class="report-btn" routerLink="/distributor-report">
      <div class="btn-icon">üìà</div>
      <span>Tendencias y Planeaci√≥n</span>
    </button>
    </div>
  </div>

  <ng-container *ngIf="!isEnterpriseUser || hasSearched">

    <div class="intro-section" *ngIf="!hasSearched">
      <div class="main-logo-section">
        <img src="assets/images/logo.png" alt="Syntara Main Logo" class="main-logo">
      </div>
      <h2 class="search-prompt">¬øQu√© producto quieres buscar hoy<span *ngIf="greetingName"> {{ greetingName }}</span>?
      </h2>
    </div>

    <div class="results-section" *ngIf="hasSearched">
      <h2 class="results-title">
        Resultados de b√∫squeda <br>
        <span
          [appTypewriter]="resultsTitleText"
          [typingSpeed]="40"
          style="min-height: 30px; display: block; font-weight: 400; font-size: 22px; margin-top: 8px;">
      </span>
      </h2>

      <div *ngIf="isLoading" class="loading-indicator">
        <div class="spinner"></div>
        <p>Buscando los mejores precios...</p>
      </div>

      <div *ngIf="generalError && !isLoading" class="error-message">
        <p>{{ generalError }}</p>
      </div>

      <div class="results-table-container" *ngIf="!isLoading && results.length > 0">
        <table class="results-table">
          <thead>
          <tr>
            <th>TIENDA</th>
            <th>PRECIO</th>
            <th>PRECIO POR UND</th>

            <th *ngIf="hasProFeatures" class="th-center">DETALLES</th>

            <th>URL</th>
            <th class="th-center">ACCI√ìN</th>
            <th>FECHA</th>
          </tr>
          </thead>

          <tbody [@listAnimation]="results.length">
          <tr *ngFor="let item of results; let first = first" [class.highlight-row]="first">
            <td class="store-name">{{ item.store }}</td>
            <td class="price-col" [class.offer-price]="item.isOffer">
              $ {{ item.price | number:'1.0-0' }}
            </td>
            <td class="unit-price-col">
              <span class="unit-price-value">$ {{ item.unitPrice | number:'1.0-0' }}</span>
              <span class="unit-price-label">/ {{ item.measureLabel }}</span>
            </td>

            <td *ngIf="hasProFeatures" class="details-cell">
              <div class="popover-wrapper">
                <button class="info-icon-btn" title="Ver detalles">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>

                <div class="popover-content">
                  <div class="popover-header">
                    <span class="popover-title">An√°lisis Syntara</span>
                  </div>
                  <div class="popover-body">
                    <p class="detail-text">{{ getDetailsContent(item) }}</p>

                    <div class="tags-row">
                      <span class="tag tag-verified" *ngIf="item.raw?.locationValidated">
                        Bogot√°
                      </span>
                      <span class="tag tag-offer" *ngIf="item.isOffer">
                        Oferta
                      </span>
                    </div>

                    <div class="meta-row" *ngIf="item.confidence">
                      <span>Confianza:</span>
                      <strong>{{ item.confidence * 100 | number:'1.0-0' }}%</strong>
                    </div>
                  </div>
                </div>
              </div>
            </td>

            <td>
              <a [href]="item.url" target="_blank" class="store-link">Ir a la tienda</a>
            </td>

            <td class="action-cell">
              <button (click)="addToCart(item)" class="cart-action-btn" title="Agregar al carrito">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                <span class="plus-sign">+</span>
              </button>
            </td>

            <td>{{ item.date | date:'shortDate' }}</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="no-results-container" *ngIf="!isLoading && results.length === 0 && !generalError">
        <div class="icon-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="no-results-icon">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <path d="M11 8v4"></path>
            <circle cx="11" cy="16" r="0.5" fill="currentColor"></circle>
          </svg>
        </div>
        <h3>¬°Ups! No encontramos ese producto</h3>
        <p>
          Parece que <strong>{{ lastSearchQuery }}</strong> no est√° disponible por ahora.
        </p>
        <div class="suggestions">
          <span>Te sugerimos:</span>
          <ul>
            <li>Revisar la ortograf√≠a de la palabra.</li>
            <li>Usar t√©rminos m√°s espec√≠ficos (ej: "Arroz Diana" en vez de "Arroz").</li>
            <li>Verificar la categor√≠a o unidad seleccionada.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="search-section" [class.search-active]="hasSearched" *ngIf="!isEnterpriseUser || hasSearched">
      <div class="search-input-wrapper product-input">
        <input
          type="text"
          placeholder="Buscar producto (Producto - Marca)..."
          class="search-input"
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()">
        <div class="search-error-tooltip" *ngIf="productError">
          {{ productError }}
        </div>
      </div>
  <div class="search-input-wrapper quantity-input">
    <input type="number"
           placeholder="Cant."
           class="search-input hide-spin-buttons"
           min="1"
           [(ngModel)]="quantity"
           (keydown)="preventInvalidCharacters($event)"
           (keyup.enter)="onSearch()">

    <div class="search-error-tooltip" *ngIf="quantityError">
      {{ quantityError }}
    </div>
  </div>
  <div class="search-input-wrapper measure-select">
    <select class="search-input" [(ngModel)]="measure">
      <option value="" disabled selected>Unidad de medida</option>
      <optgroup label="Conteo">
        <option value="unidades">Unidades</option>
        <option value="pares">Pares</option>
        <option value="docenas">Docenas</option>
        <option value="cajas">Cajas</option>
        <option value="paquetes">Paquetes</option>
        <option value="bolsas">Bolsas</option>
        <option value="kits">Kits / Sets</option>
      </optgroup>
      <optgroup label="Peso (Masa)">
        <option value="kilogramos">Kilogramos (kg)</option>
        <option value="gramos">Gramos (g)</option>
        <option value="libras">Libras (lb)</option>
      </optgroup>
      <optgroup label="Peso Tradicional">
        <option value="arrobas">Arroba</option>
        <option value="quintales">Quintales</option>
        <option value="bultos">Bultos</option>
      </optgroup>
      <optgroup label="Volumen">
        <option value="litros">Litros (L)</option>
        <option value="mililitros">Mililitros (ml)</option>
        <option value="galones">Galones</option>
      </optgroup>
      <optgroup label="Longitud/√Årea">
        <option value="metros">Metros (m)</option>
        <option value="centimetros">Cent√≠metros (cm)</option>
        <option value="metros_cuadrados">Metros Cuadrados (m¬≤)</option>
      </optgroup>
    </select>
    <div class="search-error-tooltip" *ngIf="measureError">
      {{ measureError }}
    </div>
  </div>
  <button class="search-button" (click)="onSearch()" [disabled]="isLoading">
    <span class="loading-tooltip" *ngIf="isLoading">Espera que termine la b√∫squeda</span>

    <span *ngIf="!hasSearched">Buscar</span>
    <img *ngIf="hasSearched" src="assets/images/logopequ.png" alt="Buscar" class="search-button-icon">
  </button>
</div>
  </ng-container>

  <footer class="footer" *ngIf="!hasSearched">
    <p>Syntara ‚Ä¢ Los precios hablan, Syntara escucha. ¬©</p>
  </footer>


  <div *ngIf="showToast" class="custom-toast" [ngClass]="toastType" [@toastAnimation]>
    <div class="toast-icon">
      <svg *ngIf="toastType === 'success'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>

      <svg *ngIf="toastType === 'error'" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
    </div>
    <span class="toast-text">{{ toastMessage }}</span>
  </div>
  <div *ngIf="showGuestBlockModal" class="modal-overlay">
    <div class="modal-container warning-modal">
      <div class="modal-icon">üîí</div>
      <h3>Acceso Restringido</h3>
      <p>
        Para poder seguir haciendo consultas <strong>reg√≠strate en Syntara</strong>.
      </p>
      <div class="modal-actions">
        <button (click)="closeGuestModal()" class="cancel-btn">Cancelar</button>
        <a routerLink="/register" class="confirm-btn">Registrarse</a>
      </div>
    </div>
  </div>

  <div *ngIf="showLimitModal" class="modal-overlay">
    <div class="modal-container limit-modal">
      <div class="modal-icon">‚è≥</div>
      <h3>L√≠mite Diario Alcanzado</h3>
      <p>
        Has usado tus 3 consultas gratuitas de hoy.<br>
        <strong>Suscr√≠bete al Plan Pro</strong> para continuar ahora, o espera hasta ma√±ana para tener otras 3 consultas gratis.
      </p>
      <div class="modal-actions">
        <button (click)="closeLimitModal()" class="cancel-btn">Entendido</button>
        <a routerLink="/subscription" class="confirm-btn special">Ver Planes</a>
      </div>
    </div>
  </div>

</main>
